<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Workforce Management System – FTE Calculator</title>
    <!--
        This standalone HTML file implements a lightweight workforce management
        and FTE calculation tool based on the functionality found in the
        provided Excel workbook.  It allows users to log time entries per
        employee, specify task groups and working hours, and generate
        analytics across arbitrary date ranges.  Data persists in memory
        (optionally to localStorage) and reports are computed on the fly
        without any back‑end dependencies.
    -->
    <style>
        /* Limit the height of the entries display area and add a vertical scroll bar */
.entries-container {
    max-height: 300px;   /* Adjust height as needed */
    overflow-y: auto;    /* Shows a scrollbar when needed */
}
        /* Basic resets and typography */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: #ffffff;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        .form-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        .form-section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid #4f46e5;
            padding-bottom: 8px;
        }
        .form-group {
            margin-bottom: 18px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: #ffffff;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        .time-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: #ffffff;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-right: 8px;
            margin-top: 8px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .entries-container,
        .reports-container {
            margin-top: 20px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }
        .data-table th,
        .data-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.8rem;
        }
        .data-table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #374151;
        }
        .data-table tr:hover {
            background: #f8fafc;
        }
        .report-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .report-card {
            background: #ffffff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #4f46e5;
            transition: transform 0.2s ease;
        }
        .report-card:hover {
            transform: translateY(-2px);
        }
        .report-card h3 {
            font-size: 0.9rem;
            margin-bottom: 6px;
            color: #1e293b;
        }
        .report-card .value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #4f46e5;
        }
        .report-card .label {
            color: #6b7280;
            font-size: 0.8rem;
        }
        /* Pie chart container */
        .chart-wrapper {
            /* Display canvas and legend side‑by‑side on large screens */
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        .chart-wrapper canvas {
            flex: 0 0 auto;
            width: 300px;
            height: 300px;
        }
        .legend {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-left: 20px;
        }
        .legend li {
            margin-bottom: 6px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }
        .legend span {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 6px;
            border-radius: 2px;
        }
        /* Responsive layout adjustments */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Workforce Management System</h1>
            <p>Comprehensive FTE Calculator &amp; Time Tracking Solution</p>
        </div>
        <div class="main-content">
            <!-- Time entry form -->
            <div class="form-section">
                <h2>Employee Time Entry</h2>
                <div id="alertContainer"></div>
                <div class="form-group">
                    <label for="logDate">Log Date:</label>
                    <input type="date" id="logDate" />
                </div>
                <div class="form-group">
                    <label for="employeeName">Employee Name:</label>
                    <select id="employeeName"></select>
                </div>
                <div class="form-group">
                    <label for="taskDescription">Task Description:</label>
                    <textarea id="taskDescription" placeholder="Describe the task performed..."></textarea>
                </div>
                <div class="form-group">
                    <label for="taskGroup">Task Group:</label>
                    <select id="taskGroup"></select>
                </div>
                <div class="form-group time-group">
                    <div>
                        <label for="startTime">Start Time:</label>
                        <select id="startTime"></select>
                    </div>
                    <div>
                        <label for="endTime">End Time:</label>
                        <select id="endTime"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="leaveStatus">Leave Status:</label>
                    <select id="leaveStatus">
                        <option value="none">None</option>
                        <option value="vacation">Vacation</option>
                        <option value="sick">Sick Leave</option>
                        <option value="maternity">Maternity Leave</option>
                        <option value="paternity">Paternity Leave</option>
                        <option value="others">Others</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="overtimeStatus">Overtime Status:</label>
                    <select id="overtimeStatus">
                        <option value="none">None</option>
                        <option value="authorized">Authorized</option>
                    </select>
                </div>
                <button class="btn" id="addEntryBtn">Add Entry</button>
                <button class="btn btn-secondary" id="generateReportBtn">Generate Report</button>
                <button class="btn btn-secondary" id="saveDataBtn">Save Data</button>
                <button class="btn btn-danger" id="clearDataBtn">Clear All Data</button>
            </div>
            <!-- Entries display -->
            <div class="form-section">
                <h2>Current Entries (<span id="entryCount">0</span>)</h2>
                <div id="entriesDisplay" class="entries-container">
                    <p>No entries yet. Add your first time entry to get started!</p>
                </div>
            </div>
            <!-- Reporting controls and output -->
            <div class="form-section" style="grid-column: 1 / -1;">
                <h2>Workforce Analytics &amp; FTE Reports</h2>
                <div class="form-group" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
                    <div style="flex:1; min-width: 200px;">
                        <label for="reportEmployee">Report Employee:</label>
                        <select id="reportEmployee"></select>
                    </div>
                    <div style="flex:1; min-width: 180px;">
                        <label for="reportStart">Start Date:</label>
                        <input type="date" id="reportStart" />
                    </div>
                    <div style="flex:1; min-width: 180px;">
                        <label for="reportEnd">End Date:</label>
                        <input type="date" id="reportEnd" />
                    </div>
                    <div style="flex-basis: 100px;">
                        <button class="btn" id="applyFilterBtn" style="margin-top: 24px;">Apply Filter</button>
                    </div>
                </div>
                <div id="reportsDisplay" class="reports-container">
                    <p>Generate a report to view detailed analytics and FTE calculations.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
    // Data arrays for employees and task groups extracted from the provided Excel workbook.
    const employeeList = [
        'All Employees',
        'DR. ARLENE S. SY', 'MR. ALLEN JAY P. GONDA', 'MR. NEIL IRVING QUERUBIN',
        'MS. MICHELLE M. YGAR', 'MR. REY V. ROLLON', 'MR. NEREO VILLAFLORES',
        'MS. NADIA CZARINA MAE CORTUNA', 'MS. GENECA JANEL GENETA-HALUM',
        'MS. EUNICE TADALAN-QUIBOLOY', 'MS. JULIE CHRISTINE BANDIOLA',
        'MS. MARIA LANY ROSE BRIONES', 'MS. MARY AUBREY FINEZA',
        'MR. RAFH L. MARASIGAN', 'MR. LAWRENCE EDWARD MANEJA',
        'MS. AYCA P. HERNANDEZ', 'MS.DANA TWAIN SOLANO', 'MR. KEVIN JOHN DANDOY',
        'MR. ROMMEL L. CALANO', 'MR. ERMIL D. SADOL', 'MR. MARK RAVEN JAY G. DULAY',
        'MS. LYNNE DENISE TIQUIS', 'ENGR. MARK JUDE GUERRERO', 'MR. JUN JUN ESGUERRA III',
        'MS. JEDY ARA TURGA', 'MS. MARY SHIELL PANGANIBAN', 'MS. CAROL CALLO',
        'MS. ARMI A. CABITAC', 'MR. ALDRIN VALBUENA', 'MS. MARIA MAGNA HERNANDEZ-TRIA',
        'MR. JAN LESTER O. EDJAN', 'MR. ARDENNES ESAR', 'MR. JAY REYES'
    ];
    const taskGroupList = [
        'Health Systems Development and Policy Assistance',
        'Stakeholder Engagement',
        'Supply Chain and Logistics Coordination',
        'HRH Deployment Oversight',
        'Monitoring and Evaluation (including Field Visits, Disease Surveillance & Outbreak response)',
        'Financial and Budgetary TA',
        'Advocacy Activities (pandillo/info campaigns, newsletters, CapDev community initiatives)',
        'Internal Coordination and Administration',
        'Capacity Building (internal trainings, team building, seminars, conferences)',
        'Others'
    ];
    // Generate 15‑minute time slots using 12‑hour format with AM/PM suffix.
    const timeOptions = [];
    for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 15) {
            // Convert to 12‑hour clock: 0 -> 12 AM, 1 -> 1 AM, ..., 12 -> 12 PM, 13 -> 1 PM
            const hour12 = h % 12 === 0 ? 12 : h % 12;
            const meridian = h < 12 ? 'AM' : 'PM';
            const mm = String(m).padStart(2, '0');
            timeOptions.push(`${hour12}:${mm} ${meridian}`);
        }
    }
    // Global store for time entries
    let entries = [];
    let nextId = 1;
    // Helper: display alert messages
    function showAlert(message, type = 'success') {
        const container = document.getElementById('alertContainer');
        const div = document.createElement('div');
        div.textContent = message;
        div.style.padding = '8px 12px';
        div.style.marginBottom = '10px';
        div.style.borderRadius = '6px';
        div.style.fontSize = '0.85rem';
        if (type === 'error') {
            div.style.backgroundColor = '#fee2e2';
            div.style.color = '#991b1b';
            div.style.border = '1px solid #fca5a5';
        } else {
            div.style.backgroundColor = '#ecfdf5';
            div.style.color = '#064e3b';
            div.style.border = '1px solid #a7f3d0';
        }
        container.innerHTML = '';
        container.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }
    // Populate select elements on page load
    function populateSelect(id, list) {
        const select = document.getElementById(id);
        select.innerHTML = '';
        list.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            select.appendChild(option);
        });
    }
    // Fill time selects
    function populateTimeSelect(id) {
        const select = document.getElementById(id);
        select.innerHTML = '';
        timeOptions.forEach(t => {
            const option = document.createElement('option');
            option.value = t;
            option.textContent = t;
            select.appendChild(option);
        });
    }
    // Validate form inputs
    function validateForm() {
        const logDate = document.getElementById('logDate').value;
        const employeeName = document.getElementById('employeeName').value;
        const taskGroup = document.getElementById('taskGroup').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        if (!logDate) {
            showAlert('Please select a log date.', 'error');
            return false;
        }
        if (!employeeName) {
            showAlert('Please select an employee.', 'error');
            return false;
        }
        if (!taskGroup) {
            showAlert('Please select a task group.', 'error');
            return false;
        }
        if (!startTime) {
            showAlert('Please select a start time.', 'error');
            return false;
        }
        if (!endTime) {
            showAlert('Please select an end time.', 'error');
            return false;
        }
        return true;
    }
    // Parse HH:MM string to minutes
    function parseTime(str) {
        // Expect input in the form "H:MM AM" or "H:MM PM"
        if (!str) return 0;
        const parts = str.trim().split(' ');
        let timePart = parts[0];
        let meridian = parts[1] || '';
        let [hour, minute] = timePart.split(':').map(Number);
        if (isNaN(hour) || isNaN(minute)) return 0;
        meridian = meridian.toUpperCase();
        if (meridian === 'PM' && hour !== 12) {
            hour += 12;
        } else if (meridian === 'AM' && hour === 12) {
            hour = 0;
        }
        return hour * 60 + minute;
    }
    // Calculate hours worked given start, end times and leave status
    function calculateHours(startTime, endTime, leaveStatus) {
        if (leaveStatus && leaveStatus !== 'none') {
            return 8; // authorized leave counts as 8 hours
        }
        const start = parseTime(startTime);
        let end = parseTime(endTime);
        // handle overnight shift
        if (end < start) {
            end += 24 * 60;
        }
        const diff = end - start;
        const hours = diff / 60;
        return hours > 0 ? hours : 0;
    }
    // Add a new time entry
    function addEntry() {
        if (!validateForm()) return;
        const entry = {
            id: nextId++,
            logDate: document.getElementById('logDate').value,
            employeeName: document.getElementById('employeeName').value,
            taskDescription: document.getElementById('taskDescription').value.trim() || 'No description provided',
            taskGroup: document.getElementById('taskGroup').value,
            startTime: document.getElementById('startTime').value,
            endTime: document.getElementById('endTime').value,
            leaveStatus: document.getElementById('leaveStatus').value,
            overtimeStatus: document.getElementById('overtimeStatus').value
        };
        // compute hours & daily FTE
        entry.hoursWorked = calculateHours(entry.startTime, entry.endTime, entry.leaveStatus);
        entry.dailyFTE = entry.hoursWorked / 8;
        // accumulate overtime hours if authorized
        entry.overtimeHours = 0;
        if (entry.overtimeStatus === 'authorized' && entry.hoursWorked > 8) {
            entry.overtimeHours = entry.hoursWorked - 8;
        }
        entries.push(entry);
        displayEntries();
        clearForm();
        showAlert('Entry added successfully!');
    }
    // Display current entries
    function displayEntries() {
        const container = document.getElementById('entriesDisplay');
        const countSpan = document.getElementById('entryCount');
        countSpan.textContent = entries.length;
        if (entries.length === 0) {
            container.innerHTML = '<p>No entries yet. Add your first time entry to get started!</p>';
            return;
        }
        let html = '<table class="data-table"><thead><tr>' +
            '<th>Date</th><th>Employee</th><th>Task Group</th><th>Start</th><th>End</th>' +
            '<th>Hours</th><th>FTE</th><th>Leave</th><th>OT</th><th>Action</th></tr></thead><tbody>';
        entries.forEach(entry => {
            const shortEmployee = entry.employeeName.split(' ').slice(-2).join(' ');
            const shortGroup = entry.taskGroup.length > 25 ? entry.taskGroup.substring(0, 25) + '…' : entry.taskGroup;
            html += `<tr>` +
                `<td>${entry.logDate}</td>` +
                `<td title="${entry.employeeName}">${shortEmployee}</td>` +
                `<td title="${entry.taskGroup}">${shortGroup}</td>` +
                `<td>${entry.startTime}</td>` +
                `<td>${entry.endTime}</td>` +
                `<td>${entry.hoursWorked.toFixed(2)}</td>` +
                `<td>${entry.dailyFTE.toFixed(3)}</td>` +
                `<td>${entry.leaveStatus}</td>` +
                `<td>${entry.overtimeStatus}</td>` +
                `<td><button onclick="editEntry(${entry.id})">Edit</button> <button onclick="deleteEntry(${entry.id})">Del</button></td>` +
                `</tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    // Clear form after adding
    function clearForm() {
        document.getElementById('taskDescription').value = '';
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
        document.getElementById('leaveStatus').value = 'none';
        document.getElementById('overtimeStatus').value = 'none';
    }
    // Edit an entry: load into form and remove from list until saved again
    function editEntry(id) {
        const index = entries.findIndex(e => e.id === id);
        if (index === -1) {
            showAlert('Entry not found.', 'error');
            return;
        }
        const entry = entries[index];
        document.getElementById('logDate').value = entry.logDate;
        document.getElementById('employeeName').value = entry.employeeName;
        document.getElementById('taskDescription').value = entry.taskDescription === 'No description provided' ? '' : entry.taskDescription;
        document.getElementById('taskGroup').value = entry.taskGroup;
        document.getElementById('startTime').value = entry.startTime;
        document.getElementById('endTime').value = entry.endTime;
        document.getElementById('leaveStatus').value = entry.leaveStatus;
        document.getElementById('overtimeStatus').value = entry.overtimeStatus;
        entries.splice(index, 1);
        displayEntries();
        showAlert('Entry loaded for editing. Update details and click Add Entry to save.');
    }
    // Delete an entry
    function deleteEntry(id) {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        entries = entries.filter(e => e.id !== id);
        displayEntries();
        showAlert('Entry deleted successfully.');
    }
    // Save entries to localStorage
    function saveData() {
        try {
            localStorage.setItem('timeEntries', JSON.stringify(entries));
            showAlert('Data saved to local storage!');
        } catch (e) {
            console.error('Storage failed', e);
            showAlert('Failed to save data.', 'error');
        }
    }
    // Load entries from localStorage on page load
    function loadSavedData() {
        try {
            const raw = localStorage.getItem('timeEntries');
            if (raw) {
                const saved = JSON.parse(raw);
                if (Array.isArray(saved)) {
                    entries = saved.map(item => ({
                        ...item,
                        // ensure functions & computed fields exist
                        hoursWorked: item.hoursWorked ?? calculateHours(item.startTime, item.endTime, item.leaveStatus),
                        dailyFTE: item.dailyFTE ?? ((item.hoursWorked ?? 0) / 8)
                    }));
                    nextId = entries.reduce((max, e) => Math.max(max, e.id), 0) + 1;
                    displayEntries();
                }
            }
        } catch (e) {
            console.error('Failed to load data', e);
        }
    }
    // Clear all data
    function clearAllData() {
        if (!confirm('Are you sure you want to clear all data? This cannot be undone.')) return;
        entries = [];
        nextId = 1;
        localStorage.removeItem('timeEntries');
        displayEntries();
        document.getElementById('reportsDisplay').innerHTML = '<p>Generate a report to view detailed analytics and FTE calculations.</p>';
        showAlert('All data cleared.');
    }
    // Draw a simple pie chart with legend given data array of {label,value}
    function drawPieChart(canvasId, legendId, data) {
        const canvas = document.getElementById(canvasId);
        const legend = document.getElementById(legendId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const total = data.reduce((sum, d) => sum + d.value, 0);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let startAngle = 0;
        // colour palette
        const colors = [
            '#4F46E5','#7C3AED','#059669','#FBBF24','#EF4444','#10B981','#3B82F6','#6366F1','#EC4899','#F472B6','#14B8A6'
        ];
        data.forEach((item, idx) => {
            const slice = total > 0 ? (item.value / total) * Math.PI * 2 : 0;
            // Draw slice
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, canvas.height / 2);
            ctx.arc(
                canvas.width / 2,
                canvas.height / 2,
                Math.min(canvas.width, canvas.height) / 2 - 10,
                startAngle,
                startAngle + slice
            );
            ctx.closePath();
            ctx.fillStyle = colors[idx % colors.length];
            ctx.fill();
            // Draw percentage label inside slice
            if (slice > 0) {
                const midAngle = startAngle + slice / 2;
                const radius = (Math.min(canvas.width, canvas.height) / 2 - 10) * 0.6;
                const labelX = canvas.width / 2 + radius * Math.cos(midAngle);
                const labelY = canvas.height / 2 + radius * Math.sin(midAngle);
                const percentage = ((item.value / total) * 100).toFixed(1) + '%';
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(percentage, labelX, labelY);
            }
            startAngle += slice;
        });
        // build legend with percentages
        legend.innerHTML = '';
        data.forEach((item, idx) => {
            const li = document.createElement('li');
            const colorBox = document.createElement('span');
            colorBox.style.backgroundColor = colors[idx % colors.length];
            li.appendChild(colorBox);
            const pct = total > 0 ? ((item.value / total) * 100).toFixed(1) : '0.0';
            // Display both hours and percentage in the legend for clarity
            li.appendChild(document.createTextNode(`${item.label} (${item.value.toFixed(1)}h, ${pct}%)`));
            legend.appendChild(li);
        });
    }
    // Prepare report: filter entries by employee & date range
    function prepareReport() {
        if (entries.length === 0) {
            showAlert('Please add some time entries before generating a report.', 'error');
            return null;
        }
        const selectedEmployee = document.getElementById('reportEmployee').value;
        const startDate = document.getElementById('reportStart').value;
        const endDate = document.getElementById('reportEnd').value;
        // If date inputs are empty, treat them as unbounded
        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;
        const filtered = entries.filter(entry => {
            // employee filter
            if (selectedEmployee && selectedEmployee !== 'All Employees' && entry.employeeName !== selectedEmployee) {
                return false;
            }
            // date filter
            const dateObj = new Date(entry.logDate);
            if (start && dateObj < start) return false;
            if (end && dateObj > end) return false;
            return true;
        });
        if (filtered.length === 0) {
            showAlert('No entries found for selected filter.', 'error');
            return null;
        }
        return filtered;
    }
    // Generate and display report
    function generateReport() {
        const filtered = prepareReport();
        if (!filtered) return;
        const reportDiv = document.getElementById('reportsDisplay');
        // Build task group summary
        const taskGroups = {};
        filtered.forEach(entry => {
            if (!taskGroups[entry.taskGroup]) taskGroups[entry.taskGroup] = { hours: 0, count: 0 };
            taskGroups[entry.taskGroup].hours += entry.hoursWorked;
            taskGroups[entry.taskGroup].count += 1;
        });
        const totalHours = filtered.reduce((sum, e) => sum + e.hoursWorked, 0);
        // Compute per employee summaries
        const employees = {};
        filtered.forEach(entry => {
            if (!employees[entry.employeeName]) {
                employees[entry.employeeName] = {
                    name: entry.employeeName,
                    totalHours: 0,
                    workingDays: new Set(),
                    weekly: {},
                    monthly: {},
                    overtimeHours: 0
                };
            }
            const emp = employees[entry.employeeName];
            emp.totalHours += entry.hoursWorked;
            emp.workingDays.add(entry.logDate);
            // accumulate weekly & monthly hours
            const date = new Date(entry.logDate);
            const weekKey = getWeekKey(date);
            const monthKey = getMonthKey(date);
            emp.weekly[weekKey] = (emp.weekly[weekKey] || 0) + entry.hoursWorked;
            emp.monthly[monthKey] = (emp.monthly[monthKey] || 0) + entry.hoursWorked;
            emp.overtimeHours += entry.overtimeHours || 0;
        });
        // Convert employees object to array with computed metrics
        const employeeArray = Object.values(employees).map(emp => {
            const workingDaysCount = emp.workingDays.size;
            const avgDailyHours = workingDaysCount > 0 ? emp.totalHours / workingDaysCount : 0;
            const avgDailyFTE = avgDailyHours / 8;
            const weeklyHours = Object.values(emp.weekly);
            const weeklyFTEs = weeklyHours.map(h => h / 40);
            const avgWeeklyFTE = weeklyFTEs.length > 0 ? weeklyFTEs.reduce((sum, f) => sum + f, 0) / weeklyFTEs.length : 0;
            const monthlyHours = Object.values(emp.monthly);
            const monthlyFTEs = monthlyHours.map(h => h / 160);
            const avgMonthlyFTE = monthlyFTEs.length > 0 ? monthlyFTEs.reduce((sum, f) => sum + f, 0) / monthlyFTEs.length : 0;
            return {
                ...emp,
                workingDaysCount,
                avgDailyHours,
                avgDailyFTE,
                weeklyHours,
                weeklyFTEs,
                avgWeeklyFTE,
                monthlyHours,
                monthlyFTEs,
                avgMonthlyFTE
            };
        });
        // Overall summary metrics
        const totalEmployees = employeeArray.length;
        const totalWorkingDays = employeeArray.reduce((sum, emp) => sum + emp.workingDaysCount, 0);
        const averageHoursPerEmployee = totalEmployees > 0 ? totalHours / totalEmployees : 0;
        const overallAverageFTE = employeeArray.length > 0 ? employeeArray.reduce((sum, emp) => sum + emp.avgDailyFTE, 0) / employeeArray.length : 0;
        // Build HTML for report
        let html = '';
        // Summary cards
        html += '<div class="report-card-grid">';
        html += `<div class="report-card"><h3>Total Employees</h3><div class="value">${totalEmployees}</div><div class="label">Active employees tracked</div></div>`;
        html += `<div class="report-card"><h3>Total Hours</h3><div class="value">${totalHours.toFixed(1)}</div><div class="label">Combined work hours</div></div>`;
        html += `<div class="report-card"><h3>Total Working Days</h3><div class="value">${totalWorkingDays}</div><div class="label">Days with logged hours</div></div>`;
        html += `<div class="report-card"><h3>Avg Hours/Employee</h3><div class="value">${averageHoursPerEmployee.toFixed(1)}</div><div class="label">Per employee average</div></div>`;
        html += `<div class="report-card"><h3>Overall Avg FTE</h3><div class="value">${overallAverageFTE.toFixed(3)}</div><div class="label">Daily FTE average</div></div>`;
        html += `<div class="report-card"><h3>Total Entries</h3><div class="value">${filtered.length}</div><div class="label">Time log entries</div></div>`;
        html += '</div>';
        // Task group distribution section
        html += '<h3>Task Group Distribution</h3>';
        html += '<div class="chart-wrapper">';
        html += '<canvas id="pieChart" width="300" height="300"></canvas>';
        html += '<ul id="pieLegend" class="legend"></ul>';
        html += '</div>';
        html += '<table class="data-table"><thead><tr><th>Task Group</th><th>Total Hours</th><th>Percentage</th><th>Entries</th><th>Avg Hours/Entry</th></tr></thead><tbody>';
        const taskGroupData = [];
        Object.entries(taskGroups).sort((a, b) => b[1].hours - a[1].hours).forEach(([name, data]) => {
            const pct = totalHours > 0 ? (data.hours / totalHours * 100).toFixed(1) : '0.0';
            const avgPerEntry = data.count > 0 ? (data.hours / data.count).toFixed(2) : '0.00';
            html += `<tr><td>${name}</td><td>${data.hours.toFixed(2)}</td><td>${pct}%</td><td>${data.count}</td><td>${avgPerEntry}</td></tr>`;
            taskGroupData.push({ label: name, value: data.hours });
        });
        html += '</tbody></table>';
        // Detailed employee table
        html += '<h3>Detailed Employee FTE Report</h3>';
        html += '<table class="data-table"><thead><tr><th>Employee</th><th>Total Hours</th><th>Working Days</th><th>Avg Daily Hours</th><th>Daily FTE</th><th>Avg Weekly FTE</th><th>Avg Monthly FTE</th><th>Task Groups</th><th>Overtime Hours</th></tr></thead><tbody>';
        employeeArray.forEach(emp => {
            html += `<tr><td>${emp.name}</td><td>${emp.totalHours.toFixed(2)}</td><td>${emp.workingDaysCount}</td><td>${emp.avgDailyHours.toFixed(2)}</td><td>${emp.avgDailyFTE.toFixed(3)}</td><td>${emp.avgWeeklyFTE.toFixed(3)}</td><td>${emp.avgMonthlyFTE.toFixed(3)}</td><td>${Object.keys(emp.weekly).length}</td><td>${emp.overtimeHours.toFixed(2)}</td></tr>`;
        });
        html += '</tbody></table>';
        // Weekly summary section
        html += '<h3>Weekly Summary</h3>';
        html += '<p><strong>Note:</strong> Weekly FTE is calculated based on a 40‑hour standard work week.</p>';
        html += '<table class="data-table"><thead><tr><th>Employee</th><th>Total Weekly Hours</th><th>Weeks</th><th>Avg Weekly Hours</th><th>Avg Weekly FTE</th></tr></thead><tbody>';
        employeeArray.forEach(emp => {
            const totalWeeklyHours = emp.weeklyHours.reduce((sum, h) => sum + h, 0);
            const weeks = emp.weeklyHours.length;
            const avgWeeklyHours = weeks > 0 ? totalWeeklyHours / weeks : 0;
            html += `<tr><td>${emp.name}</td><td>${totalWeeklyHours.toFixed(2)}</td><td>${weeks}</td><td>${avgWeeklyHours.toFixed(2)}</td><td>${emp.avgWeeklyFTE.toFixed(3)}</td></tr>`;
        });
        html += '</tbody></table>';
        // Monthly summary section
        html += '<h3>Monthly Summary</h3>';
        html += '<p><strong>Note:</strong> Monthly FTE is calculated based on a 160‑hour standard work month (20 working days × 8 hours).</p>';
        html += '<table class="data-table"><thead><tr><th>Employee</th><th>Total Monthly Hours</th><th>Months</th><th>Avg Monthly Hours</th><th>Avg Monthly FTE</th></tr></thead><tbody>';
        employeeArray.forEach(emp => {
            const totalMonthlyHours = emp.monthlyHours.reduce((sum, h) => sum + h, 0);
            const months = emp.monthlyHours.length;
            const avgMonthlyHours = months > 0 ? totalMonthlyHours / months : 0;
            html += `<tr><td>${emp.name}</td><td>${totalMonthlyHours.toFixed(2)}</td><td>${months}</td><td>${avgMonthlyHours.toFixed(2)}</td><td>${emp.avgMonthlyFTE.toFixed(3)}</td></tr>`;
        });
        html += '</tbody></table>';
        reportDiv.innerHTML = html;
        // Draw pie chart
        drawPieChart('pieChart', 'pieLegend', taskGroupData);
    }
    // Utility functions for week and month keys
    function getWeekKey(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNumber = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return `${d.getUTCFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
    }
    function getMonthKey(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        return `${year}-${String(month).padStart(2, '0')}`;
    }
    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        populateSelect('employeeName', employeeList.filter(name => name !== 'All Employees'));
        // duplicate list for report filter but include "All Employees" at top
        const reportList = [...employeeList];
        populateSelect('reportEmployee', reportList);
        populateSelect('taskGroup', taskGroupList);
        populateTimeSelect('startTime');
        populateTimeSelect('endTime');
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('logDate').value = today;
        document.getElementById('reportStart').value = '';
        document.getElementById('reportEnd').value = '';
        // Load persisted entries
        loadSavedData();
        // Attach button handlers
        document.getElementById('addEntryBtn').addEventListener('click', addEntry);
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
        document.getElementById('saveDataBtn').addEventListener('click', saveData);
        document.getElementById('generateReportBtn').addEventListener('click', () => {
            // before generating, populate report filters with earliest and latest dates if not set
            if (entries.length > 0) {
                const dates = entries.map(e => new Date(e.logDate)).sort((a, b) => a - b);
                document.getElementById('reportStart').value = dates[0].toISOString().split('T')[0];
                document.getElementById('reportEnd').value = dates[dates.length - 1].toISOString().split('T')[0];
            }
            generateReport();
        });
        document.getElementById('applyFilterBtn').addEventListener('click', generateReport);
    });
    </script>
</body>
</html>
